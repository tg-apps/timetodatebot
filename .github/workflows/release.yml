name: Release Bot

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Release notes for this version"
        required: false
        type: string
        default: "Automated release"

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        run: bun run test

      - name: Format code
        run: bun run format

      - name: Build binary
        run: bun run build

      - name: Generate version
        id: version
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d-%H-%M")
          echo "version=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Release version: $TIMESTAMP"

      - name: Create release directory
        run: |
          mkdir -p release
          cp dist/bot release/timetodatebot

      - name: Generate SHA256 checksum
        run: |
          cd release
          sha256sum timetodatebot > timetodatebot.sha256
          cat timetodatebot.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ${{ github.event.inputs.release_notes }}

            ## Installation

            1. Download the `timetodatebot` binary
            2. Make it executable: `chmod +x timetodatebot`
            3. Run: `./timetodatebot`

            ## Verification

            Verify the binary integrity with:
            ```bash
            sha256sum -c timetodatebot.sha256
            ```

            **Built with Bun** | **Linux ARM64**
          files: |
            release/timetodatebot
            release/timetodatebot.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
